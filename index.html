<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3D Minecraft Skin Painter</title>
<style>
  body { margin:0; overflow:hidden; background:#111; color:white; font-family:Arial,sans-serif; }
  #ui { position:absolute; top:10px; left:10px; z-index:10; }
  button, input[type=color] { margin:5px; padding:8px; border-radius:5px; border:none; font-weight:bold; }
  #bucketBtn.active { background: dodgerblue; color:white; }
  #previewContainer { position:absolute; top:10px; right:10px; border:2px solid white; }
  #preview2D { width:256px; height:256px; image-rendering: pixelated; background:white; }
</style>
</head>
<body>

<div id="ui">
  <input type="color" id="colorPicker" value="#00ff00">
  <button id="eraserBtn">Eraser</button>
  <button id="bucketBtn">Paint Bucket</button>
  <button id="undoBtn">Undo</button>
  <button id="downloadBtn">Download Skin</button>
</div>

<div id="previewContainer">
  <canvas id="preview2D" width="64" height="64"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>

<script>
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

let controls = new THREE.OrbitControls(camera, renderer.domElement);
camera.position.set(3,3,5);
controls.update();

let light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(5,10,7);
scene.add(light);

// --- Skin canvas ---
let skinCanvas = document.createElement('canvas');
skinCanvas.width = 64;
skinCanvas.height = 64;
let skinCtx = skinCanvas.getContext('2d');
skinCtx.fillStyle = "#ffffff";
skinCtx.fillRect(0,0,64,64);

let skinTexture = new THREE.CanvasTexture(skinCanvas);
let skinMaterial = new THREE.MeshBasicMaterial({map: skinTexture});

// --- Minecraft Player parts ---
let parts = [];
function createBox(w,h,d,x,y,z){
  let box = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), skinMaterial);
  box.position.set(x,y,z);
  scene.add(box);
  parts.push(box);
}
createBox(1,1,1,0,2.5,0); // head
createBox(1,1.5,0.5,0,1.25,0); // body
createBox(0.5,1.5,0.5,-0.75,1.25,0); // left arm
createBox(0.5,1.5,0.5,0.75,1.25,0); // right arm
createBox(0.5,1.5,0.5,-0.25,-0.5,0); // left leg
createBox(0.5,1.5,0.5,0.25,-0.5,0); // right leg

camera.position.z = 6;

let painting=false;
let erasing=false;
let bucketMode=false;
let undoStack=[];

function saveState(){
  if(undoStack.length>20) undoStack.shift();
  undoStack.push(skinCtx.getImageData(0,0,64,64));
}
function restoreState(){
  if(undoStack.length==0) return;
  skinCtx.putImageData(undoStack.pop(),0,0);
  skinTexture.needsUpdate=true;
  updatePreview2D();
}

// --- Paint / bucket logic ---
function getUVFromMouse(event){
  let mouse = new THREE.Vector2();
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
  let raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse,camera);
  let intersects = raycaster.intersectObjects(parts);
  if(intersects.length>0){
    let uv = intersects[0].uv;
    if(!uv) return null;
    uv.x = Math.floor(uv.x*64);
    uv.y = Math.floor((1-uv.y)*64);
    return uv;
  }
  return null;
}

// Flood-fill for bucket
function bucketFill(x, y, fillColor){
  const imgData = skinCtx.getImageData(0,0,64,64);
  const data = imgData.data;
  const targetIndex = (y*64 + x)*4;
  const targetColor = data.slice(targetIndex, targetIndex+4);
  const newColor = hexToRGBA(fillColor);
  if(colorsMatch(targetColor,newColor)) return;

  let stack=[[x,y]];
  while(stack.length){
    let [px,py]=stack.pop();
    let index = (py*64 + px)*4;
    let currColor = data.slice(index,index+4);
    if(!colorsMatch(currColor,targetColor)) continue;

    data[index]=newColor[0];
    data[index+1]=newColor[1];
    data[index+2]=newColor[2];
    data[index+3]=newColor[3];

    if(px>0) stack.push([px-1,py]);
    if(px<63) stack.push([px+1,py]);
    if(py>0) stack.push([px,py-1]);
    if(py<63) stack.push([px,py+1]);
  }
  skinCtx.putImageData(imgData,0,0);
  skinTexture.needsUpdate=true;
  updatePreview2D();
}

function hexToRGBA(hex){
  const bigint = parseInt(hex.slice(1),16);
  return [(bigint>>16)&255,(bigint>>8)&255, bigint&255,255];
}
function colorsMatch(a,b){ return a[0]===b[0] && a[1]===b[1] && a[2]===b[2] && a[3]===b[3]; }

renderer.domElement.addEventListener('mousedown',(e)=>{ painting=true; });
renderer.domElement.addEventListener('mouseup',(e)=>{ painting=false; saveState(); });
renderer.domElement.addEventListener('mousemove',(e)=>{
  if(!painting) return;
  let uv = getUVFromMouse(e);
  if(uv){
    if(bucketMode){
      bucketFill(uv.x, uv.y, document.getElementById('colorPicker').value);
    }else{
      skinCtx.fillStyle = erasing?"#ffffff":document.getElementById('colorPicker').value;
      skinCtx.fillRect(uv.x, uv.y,1,1);
      skinTexture.needsUpdate=true;
      updatePreview2D();
    }
  }
});

// --- Buttons ---
document.getElementById('eraserBtn').addEventListener('click',()=>{ erasing=!erasing; bucketMode=false; document.getElementById('bucketBtn').classList.remove('active'); });
document.getElementById('bucketBtn').addEventListener('click',()=>{
  bucketMode=!bucketMode;
  erasing=false;
  document.getElementById('bucketBtn').classList.toggle('active', bucketMode);
});
document.getElementById('undoBtn').addEventListener('click', restoreState);
document.getElementById('downloadBtn').addEventListener('click',()=>{
  let link=document.createElement('a');
  link.download="minecraft_skin.png";
  link.href=skinCanvas.toDataURL();
  link.click();
});

// --- 2D Preview ---
let previewCanvas = document.getElementById('preview2D');
let previewCtx = previewCanvas.getContext('2d');
function updatePreview2D(){
  previewCtx.clearRect(0,0,64,64);
  previewCtx.drawImage(skinCanvas,0,0);
}

// Initialize preview
updatePreview2D();

function animate(){ requestAnimationFrame(animate); renderer.render(scene,camera); }
animate();
</script>
</body>
</html>
